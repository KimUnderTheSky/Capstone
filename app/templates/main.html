<!DOCTYPE html> 
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <title>Cap Stone</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        /* 유튜브 영상 스트리밍 css */
        #video-container{
            padding-top: 20px; /* 위쪽 패딩 설정 */
            padding-left: 30px; /* 왼쪽 패딩 설정 */
        }

        /* 채팅창 css */
        #user-count-container{
            font-family: Arial, sans-serif;
        }
        #chat-box {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 350px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }
        #messages {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #messages li {
            margin-bottom: 5px;
        }
        #nickname-input {
            display: block;
            width: calc(100% - 250px);
            margin-top: 5px;
            margin-right: 3px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #chat-input {
            display: block;
            width: calc(100% - 22px);
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #send-button {
            display: block;
            width: 100%;
            margin-top: 5px;
            padding: 8px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #send-button:hover {
            background-color: #0056b3;
        }
        #input-container {
            display: flex;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.min.js"></script> 
</head> 
<body>
    <!--------------------스트리밍 html ------------------------>
    <div id="video-container">
        <iframe width="800" height="450" src="https://www.youtube.com/watch?v=-JhoMGoAfFc" frameborder="0" allowfullscreen></iframe>
    </div>
    
    <!--------------------영상 음성 감정 html ------------------------>
    
    
    <!--------------------채팅창 html ------------------------>
    <div id="chat-box">
        <div id="user-count-container">
            Currently connected users: <span id="user-count">0</span>
            <hr>
        </div>
        <ul id="messages"></ul> <!-- Messages will be displayed here -->
        <div id="input-container">
            <input type="text" id="nickname-input" placeholder="User name...">
            <input type="text" id="chat-input" placeholder="Type your message...">
        </div>
        <button id="send-button">Send</button>
    </div>
    <script type="text/javascript">
        /*------------ 음성, 영상 감정 데이터 --------------*/

        let EmotionData; // 데이터를 저장할 변수
        let TextData; // 데이터를 저장할 변수

        // emotion 데이터 요청
        setInterval(function() {
            fetch('/emotion', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                // 받은 데이터를 변수에 저장
                EmotionData = data;
                // 이 변수에 저장된 데이터를 언제든지 활용할 수 있음
                console.log(EmotionData); // 예시: 데이터 콘솔에 출력
            })
            .catch(error => console.error('Error:', error));
        }, 5000); // 5초마다 요청을 보냄
        
        // text 데이터 요청
        setInterval(function() {
            fetch('/text', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                // 받은 데이터를 변수에 저장
                TextData = data;
                // 이 변수에 저장된 데이터를 언제든지 활용할 수 있음
                console.log(TextData); // 예시: 데이터 콘솔에 출력
            })
            .catch(error => console.error('Error:', error));
        }, 150000); // 15초마다 요청을 보냄


        /*------------ 사용자 수 확인 --------------*/
        const socket = io();
        socket.on('user_count', function(count) {
            document.getElementById('user-count').textContent = count;
        });

        $(document).ready(function(){
            console.log('http://'+document.domain + ':' + location.port)
            var socket = io.connect('http://'+document.domain + ':' + location.port); 
            
            // 서버로부터 채팅 메시지를 받았을 때 처리
             socket.on('message', function (msg) {
                // console.log(msg);
                $('#messages').append('<li><strong>' + msg.nickname + '</strong>: ' + msg.message + '</li>');
                // 새로운 메시지가 추가될 때마다 자동 스크롤

                $("#messages").scrollTop($("#messages")[0].scrollHeight);
            });

            // 메시지 전송 시 닉네임도 함께 전송
            $('#send-button').on('click', function () {
                var nickname = $('#nickname-input').val();
                var message = $('#chat-input').val();
                if (nickname.trim() !== '' && message.trim() !== '') { // 값이 비어있지 않은 경우에만 전송
                    socket.send({ nickname: nickname, message: message });
                    $('#chat-input').val('');
                }
            });

            // 키보드 Enter 눌렀을 때도 닉네임과 함께 전송
            $('#chat-input').on('keypress', function (e) {
                if (e.which === 13) {
                    var nickname = $('#nickname-input').val();
                    var message = $('#chat-input').val();
                    if (nickname.trim() !== '' && message.trim() !== '') { // 값이 비어있지 않은 경우에만 전송
                        socket.send({ nickname: nickname, message: message });
                        $('#chat-input').val('');
                    }
                }
            });
        });
    </script>
</body> 
</html>